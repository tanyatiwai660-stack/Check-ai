<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AI Chat (Puter Login Auto)</title>

<style>
body{
  font-family: system-ui, Arial;
  max-width: 900px;
  margin: 0 auto;
  padding: 10px;
  background: #f4f6fb;
}

#chat{
  height: 70vh;
  overflow-y: auto;
  background: #ffffff;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

.msg{
  margin: 8px 0;
  padding: 8px 10px;
  border-radius: 6px;
  white-space: pre-wrap;
}

.user{
  background: #dbeafe;
  text-align: right;
}

.ai{
  background: #ecfeff;
}

#inputBox{
  display: flex;
  margin-top: 10px;
}

textarea{
  flex: 1;
  padding: 8px;
  font-size: 14px;
}

button{
  padding: 8px 14px;
  margin-left: 6px;
}
</style>
</head>

<body>

<h2>AI Chat</h2>

<div id="chat"></div>

<div id="inputBox">
  <textarea id="input" rows="2" placeholder="Type your messageâ€¦"></textarea>
  <button id="sendBtn">Send</button>
</div>

<script src="https://js.puter.com/v2/"></script>

<script>
const chatBox = document.getElementById("chat");
const input = document.getElementById("input");
const sendBtn = document.getElementById("sendBtn");

const messages = [];

function addMsg(text, cls){
  const div = document.createElement("div");
  div.className = "msg " + cls;
  div.textContent = text;
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}

// ðŸ” Ensure Puter Login
async function ensurePuterLogin(){
  try{
    // Simple auth check
    await puter.fs.readdir("/");
    return true;
  }catch(e){
    const returnUrl = encodeURIComponent(location.href);
    window.location.href =
      "https://puter.com/login?redirect=" + returnUrl;
    return false;
  }
}

// Check login on page load
window.onload = async ()=>{
  addMsg("ðŸ” Checking Puter loginâ€¦", "ai");
  await ensurePuterLogin();
  addMsg("âœ… Login verified. You can start chatting.", "ai");
};

// Send message
sendBtn.onclick = async ()=>{
  const text = input.value.trim();
  if(!text) return;

  input.value = "";
  addMsg(text, "user");

  messages.push({ role: "user", content: text });

  try{
    const response = await puter.ai.chat({
      model: "deepseek/deepseek-v3.2",
      messages: messages,
      max_tokens: 800
    });

    const reply = response.message.content;
    messages.push({ role: "assistant", content: reply });
    addMsg(reply, "ai");

  }catch(e){
    addMsg("ðŸ” Session expired. Redirecting to Puter loginâ€¦", "ai");
    await ensurePuterLogin();
  }
};

// Enter key support
input.addEventListener("keydown", e=>{
  if(e.key === "Enter" && !e.shiftKey){
    e.preventDefault();
    sendBtn.click();
  }
});
</script>

</body>
</html>
